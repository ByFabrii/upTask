document.addEventListener("DOMContentLoaded",(function(){!async function(){i();try{const t=`/api/tareas?id=${m()}`,a=await fetch(t),n=await a.json();console.log("Resultado de obtenerTareas:",n),e=n.tareas,d()}catch(e){console.log("Error al obtener tareas:",e)}finally{l()}}();let e=[],t=[];document.querySelector("#agregar-tarea").addEventListener("click",(function(){c()})),document.addEventListener("keydown",(function(e){e.altKey&&"n"===e.key.toLowerCase()&&(e.preventDefault(),c())})),document.addEventListener("keydown",(function(e){if("Escape"===e.key){const e=document.querySelector(".modal");e&&e.remove()}}));function a(a){const n=a.target.value;console.log("Filtro seleccionado:",n),t=""!==n?e.filter((e=>e.estado===n)):[],console.log("Tareas filtradas:",t),d()}function n(t,a=!1){const n=document.createElement("LI");n.dataset.tareaId=t.id,n.classList.add("tarea");const s=document.createElement("DIV");s.classList.add("nombre-y-opciones");const p=document.createElement("P");p.textContent=t.nombre;const f=document.createElement("DIV");f.classList.add("opciones");const y={0:"Pendiente",1:"Completa"},h=document.createElement("BUTTON");h.classList.add("estado-tarea"),void 0!==t.estado&&y[t.estado]?(h.classList.add(y[t.estado].toLowerCase()),h.textContent=y[t.estado]):(h.classList.add("pendiente"),h.textContent="Pendiente"),h.dataset.estadoTarea=t.estado??0,h.onclick=function(){a?function(e){const t="1"===e.estado?"0":"1";console.log(`Cambiando estado de la subtarea ID ${e.id} de ${e.estado} a ${t}`),e.estado=t,u(e)}({...t}):function(e){const t="1"===e.estado?"0":"1";console.log(`Cambiando estado de la tarea ID ${e.id} de ${e.estado} a ${t}`);const{tareaPadreId:a,...n}=e;u({...n,estado:t})}({...t,tareaPadreId:null})};const b=document.createElement("BUTTON");b.classList.add("editar-tarea"),b.dataset.idTarea=t.id;const E=document.createElement("I");E.classList.add("fas","fa-pencil-alt"),b.appendChild(E),b.onclick=function(){c(!0,a?{...t}:{...t,tareaPadreId:null})};const L=document.createElement("BUTTON");L.classList.add("eliminar-tarea"),L.dataset.idTarea=t.id;const v=document.createElement("I");if(v.classList.add("fas","fa-trash-alt"),L.appendChild(v),L.onclick=function(){!function(t){Swal.fire({title:"¿Eliminar Tarea?",showCancelButton:!0,confirmButtonText:"Si",cancelButtonText:"No"}).then((a=>{a.isConfirmed&&async function(t){i();const{estado:a,id:n,nombre:o}=t,r=new FormData;r.append("id",n),r.append("nombre",o),r.append("estado",a),r.append("proyectoId",m());try{const a="/api/tarea/eliminar",n=await fetch(a,{method:"POST",body:r}),o=await n.json();o.resultado&&(Swal.fire("Eliminado!",o.mensaje,"success"),e=e.filter((e=>e.id!==t.id)),d())}catch(e){console.log(e)}finally{l()}}(t)}))}({...t})},f.appendChild(h),f.appendChild(b),f.appendChild(L),s.appendChild(p),s.appendChild(f),n.appendChild(s),!a){const e=document.createElement("BUTTON");e.classList.add("desplegar-tarea"),e.dataset.idTarea=t.id;const a=document.createElement("I");a.classList.add("fas","fa-chevron-down"),e.appendChild(a);const d=document.createElement("DIV");d.classList.add("subtareas"),d.style.display="none";const c=document.createElement("UL");d.appendChild(c),e.onclick=function(){const e=this.dataset.idTarea;"none"===d.style.display?(r(t.subtareas,c),d.style.display="block",o.add(e)):(d.style.display="none",o.delete(e))},f.appendChild(e),n.appendChild(d)}return n}document.querySelectorAll('#filtros input[type="radio').forEach((e=>{e.addEventListener("input",a)})),document.addEventListener("DOMContentLoaded",(function(){document.querySelectorAll(".duplicar-proyecto").forEach((e=>{e.addEventListener("click",(function(e){e.preventDefault();!async function(e){try{const t=new FormData;t.append("id",e);const a="/duplicar-proyecto",n=await fetch(a,{method:"POST",body:t}),o=await n.json();o.resultado?(Swal.fire("Duplicado!",o.mensaje,"success"),location.reload()):Swal.fire("Error!","No se pudo duplicar el proyecto","error")}catch(e){console.error("Error al duplicar el proyecto:",e),Swal.fire("Error!","No se pudo duplicar el proyecto","error")}}(e.target.dataset.id)}))}))}));const o=new Set;function d(){!function(){const e=document.querySelector("#listado-tareas");for(;e.firstChild;)e.removeChild(e.firstChild)}(),function(){const t=e.filter((e=>"0"===e.estado)),a=document.querySelector("#pendientes");0===t.length?a.disabled=!0:a.disabled=!1}(),function(){const t=e.filter((e=>"1"===e.estado)),a=document.querySelector("#completadas");0===t.length?a.disabled=!0:a.disabled=!1}();const a=t.length?t:e,d=document.querySelector("#listado-tareas");if(0===a.length){const e=document.createElement("LI");return e.textContent="No Hay Tareas",e.classList.add("no-tareas"),void d.appendChild(e)}const c=new Set(o);a.forEach((e=>{const t=n(e,!1);if(d.appendChild(t),c.has(e.id.toString())){const a=t.querySelector(".subtareas"),n=a.querySelector("ul");r(e.subtareas,n),a.style.display="block"}}))}function r(e,t){if(t.innerHTML="",0===e.length){const e=document.createElement("LI");e.textContent="No hay subtareas relacionadas",t.appendChild(e)}else e.forEach((e=>{const a=n(e,!0);t.appendChild(a)}))}function c(t=!1,a={}){console.log(a);const n=document.createElement("DIV");n.classList.add("modal"),n.innerHTML=`\n            <form class="formulario nueva-tarea">\n                <legend>${t?"Editar Tarea":"Añade una nueva tarea"}</legend>\n                <div class="campo">\n                    <label>Tarea</label>\n                    <input \n                        type="text"\n                        name="tarea"\n                        placeholder="${a.nombre?"Edita la Tarea":"Añadir Tarea al Proyecto Actual"}"\n                        id="tarea"\n                        value="${a.nombre?a.nombre:""}"\n                        autofocus\n                    />\n                </div>\n                <div class="campo">\n                    <label>Descripción</label>\n                    <textarea \n                        type="text"\n                        name="descripcion"\n                        placeholder="${a.descripcion?"Edita la descripcion":"Añadir descripcion a la tarea Actual"}"\n                        id="descripcion"\n                        value="${a.descripcion?a.descripcion:""}"\n                        autofocus\n                    /></textarea>\n                </div>\n                <div class="opciones">\n                    <input \n                        type="submit" \n                        class="submit-nueva-tarea" \n                        value="${a.nombre?"Guardar Cambios":"Añadir Tarea"} " \n                    />\n                    <button type="button" class="cerrar-modal">Cancelar</button>\n                </div>\n            </form>\n        `,setTimeout((()=>{document.querySelector(".formulario").classList.add("animar"),document.querySelector("#tarea").focus()}),150),n.addEventListener("click",(function(o){if(o.preventDefault(),o.target.classList.contains("cerrar-modal")){document.querySelector(".formulario").classList.add("cerrar"),setTimeout((()=>{n.remove()}),500)}if(o.target.classList.contains("submit-nueva-tarea")){const n=document.querySelector("#tarea").value.trim();if(""===n)return void s("El Nombre de la tarea es Obligatorio","error");t?(a.nombre=n,u(a).then((()=>{document.querySelector(".formulario").classList.add("cerrar"),setTimeout((()=>{const e=document.querySelector(".modal");e&&e.remove()}),500)}))):async function(t){i();const a=new FormData;a.append("nombre",t),a.append("proyectoId",m());try{const n="/api/tarea",o=await fetch(n,{method:"POST",body:a}),r=await o.json();if(s(r.mensaje,r.tipo,document.querySelector(".formulario legend")),"exito"===r.tipo){const a=document.querySelector(".modal");setTimeout((()=>{a.remove()}),500);const n={id:String(r.id),nombre:t,estado:"0",proyectoId:r.proyectoId};e=[...e,n],d()}}catch(e){console.log(e)}finally{l()}}(n)}})),document.querySelector(".dashboard").appendChild(n)}function s(e,t,a){console.log(`Mostrando alerta: ${e} de tipo ${t}`);const n=document.querySelector(".alerta");n&&n.remove();const o=document.createElement("DIV");o.classList.add("alerta",t),o.textContent=e,a.parentElement.insertBefore(o,a.nextElementSibling),setTimeout((()=>{o.remove()}),5e3)}function i(){const e=document.getElementById("loader");e&&(e.style.display="flex")}function l(){const e=document.getElementById("loader");e&&(e.style.display="none")}async function u(t){i();const{estado:a,id:n,nombre:o,proyectoId:r,tareaPadreId:c}=t,s=new FormData;s.append("id",n),s.append("nombre",o),s.append("estado",a),s.append("proyectoId",r),c&&s.append("tareaPadreId",c);try{const t="/api/tarea/actualizar",i=await fetch(t,{method:"POST",body:s});if((await i.json()).exito){let t;if(c){const d=e.find((e=>e.id===c));d&&d.subtareas&&(t=d.subtareas.findIndex((e=>e.id===n)),-1!==t&&(d.subtareas[t]={...d.subtareas[t],estado:a,nombre:o,proyectoId:r}))}else t=e.findIndex((e=>e.id===n)),-1!==t&&(e[t]={...e[t],estado:a,nombre:o,proyectoId:r});d(),Swal.fire({title:"Estado actualizado",text:`El estado de la ${c?"subtarea":"tarea"} "${o}" ha sido actualizado.`,icon:"success",confirmButtonText:"OK"})}}catch(e){console.error(e)}finally{l()}}function m(){const e=new URLSearchParams(window.location.search);return Object.fromEntries(e.entries()).id}}));